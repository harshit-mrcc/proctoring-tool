<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proctoring Tool | Setup</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body class="registration-page">
  <header class="navbar">
    <div class="nav-inner">
      <div class="brand">Proctoring Tool</div>
      <div class="nav-actions">
        <a class="nav-link" href="/">Setup</a>
        <a class="nav-link" href="/admin/login">Admin Login</a>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>Exam Pre-check</h1>
    <p class="subtitle">Enter basic details and complete checks before face registration.</p>

    <section class="card setup-instructions">
      <h2>Instructions</h2>
      <ul>
        <li>Use desktop/laptop only. Mobile devices are blocked.</li>
        <li>Keep your face visible with good room lighting.</li>
        <li>Use stable internet with minimum {{ min_download_mbps }} Mbps download speed.</li>
        <li>Allow camera and microphone permissions.</li>
      </ul>
    </section>

    <section class="card">
      <div class="candidate-grid">
        <div>
          <label for="firstName">First Name</label>
          <input id="firstName" type="text" placeholder="Enter first name" autocomplete="given-name" />
        </div>
        <div>
          <label for="lastName">Last Name</label>
          <input id="lastName" type="text" placeholder="Enter last name" autocomplete="family-name" />
        </div>
        <div>
          <label for="email">Email (Optional)</label>
          <input id="email" type="text" placeholder="name@example.com" autocomplete="email" />
        </div>
      </div>

      <div class="video-box">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="captureCanvas" width="640" height="480" hidden></canvas>
      </div>

      <div class="checklist-card">
        <p class="preview-title">System Checks</p>
        <div class="check-row"><span>Desktop/Laptop device</span><strong id="checkDevice" class="check-pill pending">Pending</strong></div>
        <div class="check-row"><span>Internet speed</span><strong id="checkInternet" class="check-pill pending">Pending</strong></div>
        <div class="check-row"><span>Microphone</span><strong id="checkMic" class="check-pill pending">Pending</strong></div>
        <div class="check-row"><span>Lighting</span><strong id="checkLighting" class="check-pill pending">Pending</strong></div>
      </div>

      <div class="actions">
        <button id="enableCameraBtn" class="btn setup-step-btn">1. Enable Camera</button>
        <button id="enableMicBtn" class="btn setup-step-btn" disabled>2. Enable Microphone</button>
        <button id="runChecksBtn" class="btn setup-step-btn" disabled>3. Run Pre-checks</button>
        <button id="continueBtn" class="btn btn-primary setup-step-btn" disabled>4. Continue to Face Registration</button>
      </div>

      <div id="nextStepBox" class="next-step-box">
        <strong>Next Step</strong>
        <p id="nextStepText">Click "1. Enable Camera" to start.</p>
      </div>
      <p id="statusText" class="status-text">Waiting for camera...</p>
    </section>
  </main>
  <div id="registrationToast" class="warning-toast hidden"></div>

  <script>
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('captureCanvas');
    const ctx = canvas.getContext('2d');

    const firstNameInput = document.getElementById('firstName');
    const lastNameInput = document.getElementById('lastName');
    const emailInput = document.getElementById('email');
    const statusText = document.getElementById('statusText');

    const enableCameraBtn = document.getElementById('enableCameraBtn');
    const enableMicBtn = document.getElementById('enableMicBtn');
    const runChecksBtn = document.getElementById('runChecksBtn');
    const continueBtn = document.getElementById('continueBtn');

    const checkDevice = document.getElementById('checkDevice');
    const checkInternet = document.getElementById('checkInternet');
    const checkMic = document.getElementById('checkMic');
    const checkLighting = document.getElementById('checkLighting');
    const nextStepText = document.getElementById('nextStepText');
    const registrationToast = document.getElementById('registrationToast');

    const mobileDetected = {{ mobile_detected | tojson }};
    const errorCode = {{ error_code | tojson }};
    const minDownloadMbps = Number({{ min_download_mbps | tojson }});

    let cameraReady = false;
    let micPermissionGranted = false;
    let mobileBlocked = Boolean(mobileDetected) || errorCode === 'mobile';
    let toastTimer = null;

    const checks = {
      device: !mobileBlocked,
      internet: null,
      mic: null,
      lighting: null,
    };

    function detectMobileClientSide() {
      const ua = (navigator.userAgent || '').toLowerCase();
      const mobileRegex = /android|iphone|ipad|ipod|mobile|iemobile|opera mini|tablet|silk|kindle/;
      const touchMac = ua.includes('macintosh') && navigator.maxTouchPoints > 1;
      const desktopRegex = /windows nt|x11;|cros|linux x86_64|macintosh/;
      if (desktopRegex.test(ua) && !touchMac) {
        return false;
      }
      return mobileRegex.test(ua) || touchMac;
    }

    function setStatus(message, isError = false) {
      statusText.textContent = message;
      statusText.classList.toggle('error', isError);
    }

    function showToast(message) {
      registrationToast.textContent = message;
      registrationToast.classList.remove('hidden');
      window.clearTimeout(toastTimer);
      toastTimer = window.setTimeout(() => {
        registrationToast.classList.add('hidden');
      }, 3200);
    }

    function setCheckPill(el, ok) {
      el.classList.remove('pending', 'pass', 'fail');
      if (ok === null) {
        el.textContent = 'Pending';
        el.classList.add('pending');
        return;
      }
      el.textContent = ok ? 'Pass' : 'Fail';
      el.classList.add(ok ? 'pass' : 'fail');
    }

    function refreshChecksUI() {
      checks.device = !mobileBlocked;
      setCheckPill(checkDevice, checks.device);
      setCheckPill(checkInternet, checks.internet);
      setCheckPill(checkMic, checks.mic);
      setCheckPill(checkLighting, checks.lighting);
      refreshContinueButton();
      refreshNextStepGuidance();
    }

    function isValidName(value) {
      return /^[A-Za-z][A-Za-z' -]{0,48}$/.test(String(value || '').trim());
    }

    function hasRequiredCandidateDetails() {
      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      return Boolean(firstName) && Boolean(lastName);
    }

    function hasStrictlyValidCandidateDetails() {
      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      return isValidName(firstName) && isValidName(lastName);
    }

    function buildAutoUsername() {
      const firstName = firstNameInput.value.trim().replace(/\s+/g, ' ');
      const lastName = lastNameInput.value.trim().replace(/\s+/g, ' ');
      return `${firstName} ${lastName}`.trim();
    }

    function refreshContinueButton() {
      const allChecksPass = checks.device === true && checks.internet === true && checks.mic === true && checks.lighting === true;
      continueBtn.disabled = !(cameraReady && allChecksPass && hasRequiredCandidateDetails());
      enableMicBtn.disabled = !cameraReady || mobileBlocked;
      runChecksBtn.disabled = !cameraReady || !micPermissionGranted || mobileBlocked;
      refreshStepButtonHighlight();
    }

    function refreshStepButtonHighlight() {
      [enableCameraBtn, enableMicBtn, runChecksBtn, continueBtn].forEach((btn) => {
        btn.classList.remove('active-step');
      });

      if (mobileBlocked) {
        return;
      }

      const checksPassed = checks.internet === true && checks.mic === true && checks.lighting === true;
      if (!cameraReady) {
        enableCameraBtn.classList.add('active-step');
        return;
      }
      if (!micPermissionGranted) {
        enableMicBtn.classList.add('active-step');
        return;
      }
      if (!checksPassed) {
        runChecksBtn.classList.add('active-step');
        return;
      }
      continueBtn.classList.add('active-step');
    }

    function setNextStep(message) {
      nextStepText.textContent = message;
    }

    function refreshNextStepGuidance() {
      if (mobileBlocked) {
        setNextStep('Use a desktop/laptop browser. Mobile devices are blocked.');
        return;
      }
      if (!cameraReady) {
        setNextStep('Click "1. Enable Camera" and allow camera permission.');
        return;
      }
      if (!micPermissionGranted) {
        setNextStep('Click "2. Enable Microphone" and allow permission.');
        return;
      }
      if (!(checks.internet === true && checks.mic === true && checks.lighting === true)) {
        setNextStep('Click "3. Run Pre-checks". If anything fails, fix it and run again.');
        return;
      }
      if (!hasRequiredCandidateDetails()) {
        setNextStep('Enter first and last name to continue.');
        return;
      }
      setNextStep('All good. Click "4. Continue to Face Registration".');
    }

    function estimateLightingScore() {
      if (!webcam.videoWidth || !webcam.videoHeight) {
        return 0;
      }
      canvas.width = webcam.videoWidth;
      canvas.height = webcam.videoHeight;
      ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      let sum = 0;
      for (let i = 0; i < imageData.length; i += 4) {
        const r = imageData[i];
        const g = imageData[i + 1];
        const b = imageData[i + 2];
        sum += (0.2126 * r) + (0.7152 * g) + (0.0722 * b);
      }
      return sum / (canvas.width * canvas.height);
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function measureInternetSpeedMbps() {
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (connection && typeof connection.downlink === 'number' && connection.downlink > 0) {
        return Number(connection.downlink);
      }

      const started = performance.now();
      const response = await fetch(`/speed_probe?ts=${Date.now()}`, { cache: 'no-store' });
      const blob = await response.blob();
      const ended = performance.now();
      const durationSeconds = Math.max((ended - started) / 1000, 0.001);
      const megabits = (blob.size * 8) / 1_000_000;
      return megabits / durationSeconds;
    }

    async function runMicTest() {
      if (!micPermissionGranted) {
        throw new Error('Enable microphone first to grant permission.');
      }
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 1024;
        source.connect(analyser);
        const data = new Uint8Array(analyser.fftSize);

        const started = Date.now();
        let peak = 0;
        while (Date.now() - started < 2200) {
          analyser.getByteTimeDomainData(data);
          let sumSquares = 0;
          for (let i = 0; i < data.length; i += 1) {
            const normalized = (data[i] - 128) / 128;
            sumSquares += normalized * normalized;
          }
          const rms = Math.sqrt(sumSquares / data.length);
          peak = Math.max(peak, rms);
          await sleep(80);
        }

        source.disconnect();
        await audioContext.close();
        return peak >= 0.01;
      } finally {
        stream.getTracks().forEach((track) => track.stop());
      }
    }

    async function enableMicrophone() {
      if (mobileBlocked) {
        const mobileMsg = 'Mobile devices are not supported. Please use a desktop/laptop browser.';
        setStatus(mobileMsg, true);
        showToast(mobileMsg);
        return;
      }
      try {
        enableMicBtn.disabled = true;
        setStatus('Requesting microphone permission...');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        micPermissionGranted = true;
        checks.mic = null;
        setStatus('Microphone permission granted. You can run pre-checks now.');
        setNextStep('Now click "3. Run Pre-checks".');
        stream.getTracks().forEach((track) => track.stop());
      } catch (error) {
        micPermissionGranted = false;
        checks.mic = false;
        setStatus(`Microphone permission failed: ${error.message}`, true);
        setNextStep('Allow microphone permission in browser site settings, then retry "2. Enable Microphone".');
        showToast(`Microphone permission failed: ${error.message}`);
      } finally {
        enableMicBtn.disabled = false;
        refreshChecksUI();
      }
    }

    async function runPrechecks() {
      if (!cameraReady) {
        setStatus('Enable camera first.', true);
        setNextStep('Click "1. Enable Camera" first.');
        return;
      }
      if (!micPermissionGranted) {
        setStatus('Enable microphone first.', true);
        setNextStep('Click "2. Enable Microphone" before running pre-checks.');
        showToast('Click "Enable Microphone" and allow permission in your browser.');
        return;
      }

      setStatus('Running internet, microphone, and lighting checks...');
      runChecksBtn.disabled = true;
      try {
        const speed = await measureInternetSpeedMbps();
        checks.internet = speed >= minDownloadMbps;
        if (!checks.internet) {
          showToast(`Internet speed too low (${speed.toFixed(2)} Mbps). Minimum required is ${minDownloadMbps} Mbps.`);
        }

        checks.mic = await runMicTest();
        if (!checks.mic) {
          showToast('Microphone test failed. Ensure mic permission is granted and audio is detectable.');
        }

        const lightScore = estimateLightingScore();
        checks.lighting = lightScore >= 60;
        if (!checks.lighting) {
          showToast('Lighting is too dim. Increase room light and keep face clearly visible.');
        }

        refreshChecksUI();
        if (checks.internet && checks.mic && checks.lighting) {
          setStatus('All checks passed. Continue to face registration.');
          setNextStep('Now click "4. Continue to Face Registration".');
        } else {
          setStatus('Some checks failed. Resolve highlighted issues and run checks again.', true);
          setNextStep('Fix failed checks and click "3. Run Pre-checks" again.');
        }
      } catch (error) {
        setStatus(`Pre-check error: ${error.message}`, true);
        setNextStep('Check permissions/connectivity, then re-run "3. Run Pre-checks".');
        showToast(`Pre-check error: ${error.message}`);
      } finally {
        runChecksBtn.disabled = false;
        refreshContinueButton();
      }
    }

    async function enableCamera() {
      if (mobileBlocked) {
        const mobileMsg = 'Mobile devices are not supported. Please use a desktop/laptop browser.';
        setStatus(mobileMsg, true);
        showToast(mobileMsg);
        return;
      }
      if (cameraReady) {
        return;
      }
      try {
        enableCameraBtn.disabled = true;
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        webcam.srcObject = stream;
        await webcam.play();
        cameraReady = true;
        setStatus('Camera ready. Run pre-checks next.');
        setNextStep('Now click "2. Enable Microphone".');
      } catch (error) {
        setStatus(`Camera error: ${error.message}`, true);
        setNextStep('Allow camera permission in browser site settings, then retry "1. Enable Camera".');
        showToast(`Camera error: ${error.message}`);
        enableCameraBtn.disabled = false;
      } finally {
        refreshContinueButton();
      }
    }

    function saveCandidateInfoLocally() {
      const profile = {
        first_name: firstNameInput.value.trim(),
        last_name: lastNameInput.value.trim(),
        email: emailInput.value.trim(),
        username: buildAutoUsername(),
        updated_at: new Date().toISOString(),
      };
      window.localStorage.setItem('candidate_profile', JSON.stringify(profile));
    }

    function loadCandidateInfoLocally() {
      try {
        const raw = window.localStorage.getItem('candidate_profile');
        if (!raw) return;
        const data = JSON.parse(raw);
        firstNameInput.value = String(data.first_name || '');
        lastNameInput.value = String(data.last_name || '');
        emailInput.value = String(data.email || '');
      } catch (error) {
        // no-op
      }
    }

    function goToFaceRegistration() {
      if (!(checks.device === true && checks.internet === true && checks.mic === true && checks.lighting === true)) {
        setStatus('Run and pass all pre-checks before continuing.', true);
        setNextStep('Complete "1-3" and ensure all checks show Pass.');
        return;
      }
      if (!hasRequiredCandidateDetails()) {
        setStatus('Enter first name and last name.', true);
        setNextStep('Add first and last name, then continue.');
        return;
      }
      if (!hasStrictlyValidCandidateDetails()) {
        setStatus('Use alphabetic first/last names only.', true);
        setNextStep('Use letters, spaces, apostrophes, or hyphens only.');
        return;
      }
      saveCandidateInfoLocally();
      const username = buildAutoUsername();
      window.location.href = `/face_register?username=${encodeURIComponent(username)}`;
    }

    enableCameraBtn.addEventListener('click', enableCamera);
    enableMicBtn.addEventListener('click', enableMicrophone);
    runChecksBtn.addEventListener('click', runPrechecks);
    continueBtn.addEventListener('click', goToFaceRegistration);

    [firstNameInput, lastNameInput, emailInput].forEach((el) => {
      el.addEventListener('input', refreshContinueButton);
      el.addEventListener('blur', saveCandidateInfoLocally);
    });

    loadCandidateInfoLocally();
    mobileBlocked = mobileBlocked || detectMobileClientSide();
    refreshChecksUI();
    refreshContinueButton();
    refreshNextStepGuidance();

    fetch('/device_check')
      .then((response) => response.json())
      .then((data) => {
        if (data && data.supported === false) {
          mobileBlocked = true;
          refreshChecksUI();
          refreshNextStepGuidance();
        }
      })
      .catch(() => {
        // fallback to existing client-side detection
      });

    if (mobileBlocked) {
      enableCameraBtn.disabled = true;
      enableMicBtn.disabled = true;
      runChecksBtn.disabled = true;
      continueBtn.disabled = true;
      checks.device = false;
      refreshChecksUI();
      const mobileMsg = 'Mobile devices are not supported. Please use a desktop/laptop browser.';
      setStatus(mobileMsg, true);
      setNextStep('Switch to desktop/laptop and reload setup.');
      showToast(mobileMsg);
    }

    [firstNameInput, lastNameInput].forEach((el) => {
      el.addEventListener('input', refreshNextStepGuidance);
    });
  </script>
</body>
</html>
